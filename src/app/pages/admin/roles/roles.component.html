<p-card class="w-full bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    <div class="p-4">
        <p-toast></p-toast>
        <p-confirmDialog></p-confirmDialog>

        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
            <h2 class="text-2xl font-bold m-0">Gestión de Roles</h2>
            <button pButton pRipple label="Nuevo Rol" icon="pi pi-plus" class="p-button-success" (click)="openNew()"></button>
        </div>

        <p-table
            #dt
            [value]="roles"
            [loading]="loading"
            [rows]="10"
            [paginator]="roles.length > 10"
            [rowsPerPageOptions]="[10, 25, 50]"
            responsiveLayout="scroll"
            [globalFilterFields]="['name', 'scope', 'module']"
            [(selection)]="selectedRole"
            [rowHover]="true"
            dataKey="id"
            currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} entradas"
            [showCurrentPageReport]="roles.length > 10"
        >
            <ng-template pTemplate="caption">
                <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-3">
                    <span class="text-lg font-semibold">Lista de Roles</span>
                    <span class="p-input-icon-left w-full md:w-auto">
                        <i class="pi pi-search"></i>
                        <input
                            pInputText
                            type="text"
                            (input)="dt.filterGlobal($any($event.target).value, 'contains')"
                            placeholder="Buscar roles..."
                            class="w-full md:w-80"
                        />
                    </span>
                </div>
            </ng-template>

            <ng-template pTemplate="header">
                <tr>
                    <th pSortableColumn="name">Nombre <p-sortIcon field="name"></p-sortIcon></th>
                    <th pSortableColumn="scope">Scope <p-sortIcon field="scope"></p-sortIcon></th>
                    <th>Módulo</th>
                    <th>Acciones</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-role>
                <tr>
                    <td class="min-w-40">
                        <span class="p-column-title block font-semibold">Nombre</span>
                        {{ role.name }}
                    </td>
                    <td class="min-w-40">
                        <span class="p-column-title block font-semibold">Scope</span>
                        <span
                            [ngClass]="{
                                'px-2 py-1 text-xs rounded-full bg-green-100 text-green-700 dark:bg-green-800 dark:text-green-200': role.scope === 'GLOBAL',
                                'px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-700 dark:bg-yellow-800 dark:text-yellow-200': role.scope === 'TENANT',
                                'px-2 py-1 text-xs rounded-full bg-red-100 text-red-700 dark:bg-red-800 dark:text-red-200': role.scope === 'MODULE'
                            }"
                        >
                            {{ role.scope }}
                        </span>
                    </td>
                    <td class="min-w-32">
                        <span class="p-column-title block font-semibold">Módulo</span>
                        {{ getModuleDisplay(role.module) }}
                    </td>
                    <td>
                        <div class="flex gap-2">
                            <button
                                pButton
                                pRipple
                                icon="pi pi-pencil"
                                class="p-button-rounded p-button-sm p-button-success"
                                (click)="editRole(role)"
                                pTooltip="Editar"
                            ></button>
                            <button
                                pButton
                                pRipple
                                icon="pi pi-trash"
                                class="p-button-rounded p-button-sm p-button-danger"
                                (click)="deleteRole(role)"
                                pTooltip="Eliminar"
                            ></button>
                        </div>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="4" class="text-center p-6">
                        <div class="flex flex-col items-center gap-3">
                            <i class="pi pi-users text-6xl text-gray-300"></i>
                            <h3 class="text-xl font-semibold text-gray-600 m-0">No hay roles disponibles</h3>
                            <p class="text-gray-500 m-0">Crea tu primer rol haciendo clic en "Nuevo Rol"</p>
                            <button pButton pRipple label="Crear Primer Rol" icon="pi pi-plus" class="p-button-success mt-3" (click)="openNew()"></button>
                        </div>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>
</p-card>

<!-- DIALOGO -->
<p-dialog
    [header]="selectedRole ? 'Editar Rol' : 'Nuevo Rol'"
    [(visible)]="dialogVisible"
    [modal]="true"
    [style]="{ width: '90vw', maxWidth: '800px' }"
    [maximizable]="true"
    class="p-fluid bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100"
>
    <ng-template pTemplate="content">
        <form [formGroup]="roleForm">
            <!-- Nombre -->
            <div class="field">
                <label for="name" class="block text-xl font-medium mb-2">Nombre *</label>
                <input
                    pInputText
                    id="name"
                    formControlName="name"
                    placeholder="Nombre del rol"
                    class="w-full mb-5"
                />
                <small class="p-error" *ngIf="getFieldError('name')">{{ getFieldError('name') }}</small>
            </div>

            <!-- Descripción -->
            <div class="field">
                <label for="description" class="block text-xl font-medium mb-2">Descripción</label>
                <textarea
                    pInputTextarea
                    id="description"
                    rows="3"
                    formControlName="description"
                    placeholder="Descripción del rol"
                    class="w-full mb-5 resize-none"
                ></textarea>
            </div>

            <!-- Scope -->
            <div class="field">
                <label for="scope" class="block text-xl font-medium mb-2">Scope *</label>
                <p-select
                    id="scope"
                    [options]="scopeOptions"
                    formControlName="scope"
                    optionLabel="label"
                    optionValue="value"
                    placeholder="Seleccionar scope"
                    class="w-full mb-5"
                ></p-select>
            </div>

            <!-- Módulo -->
            <div class="field" *ngIf="roleForm.get('scope')?.value === 'MODULE'">
                <label for="module" class="block text-xl font-medium mb-2">Módulo *</label>
                <input
                    pInputText
                    id="module"
                    formControlName="module"
                    placeholder="Nombre del módulo"
                    class="w-full mb-5"
                />
            </div>

            <!-- Límites -->
            <div class="field" formGroupName="limits">
                <label class="block text-xl font-medium mb-2">Límites</label>
                <div class="formgrid grid">
                    <div class="field col">
                        <label for="max_users">Máx. Usuarios</label>
                        <input pInputText id="max_users" type="number" formControlName="max_users" class="w-full" />
                    </div>
                    <div class="field col">
                        <label for="max_storage">Máx. Almacenamiento (GB)</label>
                        <input pInputText id="max_storage" type="number" formControlName="max_storage" class="w-full" />
                    </div>
                </div>
            </div>

            <!-- Permisos -->
            <div class="field">
                <div class="flex justify-between items-center mb-3">
                    <label class="block text-xl font-medium">
                        Permisos ({{ getSelectedPermissionsCount() }}/{{ permissions.length }})
                    </label>
                    <div class="field-checkbox" *ngIf="permissions.length > 0">
                        <p-checkbox
                            [binary]="true"
                            [ngModel]="areAllPermissionsSelected()"
                            (ngModelChange)="toggleAllPermissions($event)"
                            [ngModelOptions]="{ standalone: true }"
                            inputId="selectAll"
                        ></p-checkbox>
                        <label for="selectAll" class="ml-2 font-semibold">Seleccionar todos</label>
                    </div>
                </div>

                <!-- Loading -->
                <div *ngIf="loadingStates.permissions" class="text-center p-4">
                    <i class="pi pi-spin pi-spinner text-4xl text-blue-500 mb-3"></i>
                    <p class="text-lg font-medium">Cargando permisos...</p>
                    <small class="text-gray-500">Esto puede tomar unos segundos</small>
                </div>

                <!-- Vacío -->
                <div *ngIf="!loadingStates.permissions && permissions.length === 0" class="text-center p-4">
                    <i class="pi pi-info-circle text-4xl text-gray-400 mb-3"></i>
                    <p class="text-gray-500 text-lg">No hay permisos disponibles</p>
                    <small class="text-gray-400">Los permisos se cargarán automáticamente cuando estén disponibles</small>
                </div>

                <!-- Permisos agrupados -->
                <div *ngIf="!loadingStates.permissions && permissions.length > 0" class="permissions-container">
                    <div *ngFor="let groupKey of getGroupKeys()" class="permissions-group mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <h6 class="m-0 font-semibold">{{ groupKey }} ({{ groupedPermissions[groupKey].length }})</h6>
                            <div class="field-checkbox">
                                <p-checkbox
                                    [binary]="true"
                                    [ngModel]="isGroupSelected(groupKey)"
                                    [indeterminate]="isGroupPartiallySelected(groupKey)"
                                    (ngModelChange)="toggleGroupPermissions(groupKey, $event)"
                                    [ngModelOptions]="{ standalone: true }"
                                    [inputId]="'group-' + groupKey"
                                ></p-checkbox>
                                <label [for]="'group-' + groupKey" class="ml-2 text-sm font-medium">Seleccionar grupo</label>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            <div
                                *ngFor="let permission of groupedPermissions[groupKey]; trackBy: trackByPermissionId"
                                class="field-checkbox flex items-center"
                            >
                                <p-checkbox
                                    [binary]="true"
                                    [ngModel]="isPermissionSelected(permission.id)"
                                    (ngModelChange)="togglePermission(permission.id, $event)"
                                    [ngModelOptions]="{ standalone: true }"
                                    [inputId]="'perm-' + permission.id"
                                ></p-checkbox>
                                <label [for]="'perm-' + permission.id" class="ml-2 text-sm" [title]="permission.name">
                                    {{ translatePermission(permission.name) }}
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </ng-template>

    <!-- Footer -->
    <ng-template pTemplate="footer">
        <div class="flex justify-end gap-2">
            <button pButton pRipple label="Cancelar" icon="pi pi-times" class="p-button-text" (click)="dialogVisible = false"></button>
            <button
                pButton
                pRipple
                [label]="loadingStates.saving ? 'Guardando...' : 'Guardar'"
                [icon]="loadingStates.saving ? 'pi pi-spin pi-spinner' : 'pi pi-check'"
                class="p-button-success"
                [loading]="loadingStates.saving"
                [disabled]="roleForm.invalid || loadingStates.saving"
                (click)="saveRole()"
            ></button>
        </div>
    </ng-template>
</p-dialog>
